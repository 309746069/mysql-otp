<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/Users/viktor/data/mysql-otp/.eunit/mock_tcp.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /Users/viktor/data/mysql-otp/.eunit/mock_tcp.erl by COVER 2014-12-19 at 23:31:12

****************************************************************************

        |  %% @doc A module to be used where gen_tcp is expected.
        |  %%
        |  %% A "fake socket" is used in test where we need to mock socket communication.
        |  %% It is a pid maintaining a list of expected send and recv events.
        |  -module(mock_tcp).
        |  
        |  %% gen_tcp interface functions.
        |  -export([send/2, recv/2, recv/3]).
        |  
        |  %% Functions to setup the mock_tcp.
        |  -export([create/1, close/1]).
        |  
        |  %% @doc Creates a mock_tcp process with a buffer of expected recv/2,3 and send/2
        |  %% calls. The pid of the mock_tcp process is returned.
        |  -spec create([{recv, binary()} | {send, binary()}]) -&gt; pid().
        |  create(ExpectedEvents) -&gt;
     6..|      spawn_link(fun () -&gt; loop(ExpectedEvents) end).
        |  
        |  %% @doc Receives NumBytes bytes from mock_tcp Pid. This function can be used
        |  %% as a replacement for gen_tcp:recv/2 in unit tests. If there not enough data
        |  %% in the mock_tcp's buffer, an error is raised.
        |  recv(Pid, NumBytes) -&gt;
    54..|      Pid ! {recv, NumBytes, self()},
    54..|      receive
    52..|          {ok, Data} -&gt; {ok, Data};
     1..|          error -&gt; error({unexpected_recv, NumBytes})
        |      after 100 -&gt;
     1..|          error(noreply)
        |      end.
        |  
        |  recv(Pid, NumBytes, _Timeout) -&gt;
    25..|      recv(Pid, NumBytes).
        |  
        |  %% @doc Sends data to a mock_tcp. This can be used as replacement for
        |  %% gen_tcp:send/2 in unit tests. If the data sent is not what the mock_tcp
        |  %% expected, an error is raised.
        |  send(Pid, Data) -&gt;
     4..|      Pid ! {send, iolist_to_binary(Data), self()},
     4..|      receive
     4..|          ok -&gt; ok;
<font color=red>     0..|          error -&gt; error({unexpected_send, Data})</font>
        |      after 100 -&gt;
<font color=red>     0..|          error(noreply)</font>
        |      end.
        |  
        |  %% Stops the mock_tcp process. If the mock_tcp's buffer is not empty,
        |  %% an error is raised.
        |  close(Pid) -&gt;
     5..|      Pid ! {done, self()},
     5..|      receive
     5..|          ok -&gt; ok;
<font color=red>     0..|          {remains, Remains} -&gt; error({unexpected_close, Remains})</font>
        |      after 100 -&gt;
<font color=red>     0..|          error(noreply)</font>
        |      end.
        |  
        |  %% Used by create/1.
        |  loop(AllEvents = [{Func, Data} | Events]) -&gt;
    57..|      receive
        |          {recv, NumBytes, FromPid} when Func == recv, NumBytes == size(Data) -&gt;
     5..|              FromPid ! {ok, Data},
     5..|              loop(Events);
        |          {recv, NumBytes, FromPid} when Func == recv, NumBytes &lt; size(Data) -&gt;
    47..|              &lt;&lt;Data1:NumBytes/binary, Rest/binary&gt;&gt; = Data,
    47..|              FromPid ! {ok, Data1},
    47..|              loop([{recv, Rest} | Events]);
        |          {send, Bytes, FromPid} when Func == send, Bytes == Data -&gt;
     4..|              FromPid ! ok,
     4..|              loop(Events);
        |          {send, Bytes, FromPid} when Func == send, size(Bytes) &lt; size(Data) -&gt;
<font color=red>     0..|              Size = size(Bytes),</font>
<font color=red>     0..|              case Data of</font>
        |                  &lt;&lt;Bytes:Size/binary, Rest/binary&gt;&gt; -&gt;
<font color=red>     0..|                      FromPid ! ok,</font>
<font color=red>     0..|                      loop([{send, Rest} | Events]);</font>
        |                  _ -&gt;
<font color=red>     0..|                      FromPid ! error</font>
        |              end;
        |          {_, _, FromPid} -&gt;
     1..|              FromPid ! error;
        |          {done, FromPid} -&gt;
<font color=red>     0..|              FromPid ! {remains, AllEvents}</font>
        |      end;
        |  loop([]) -&gt;
     5..|      receive
     5..|          {done, FromPid} -&gt; FromPid ! ok;
<font color=red>     0..|          {_, _, FromPid} -&gt; FromPid ! error</font>
        |      end.
        |  
        |  -ifdef(TEST).
        |  -include_lib("eunit/include/eunit.hrl").
        |  
        |  %% Tests for the mock_tcp functions.
        |  bad_recv_test() -&gt;
     1..|      Pid = create([{recv, &lt;&lt;"foobar"&gt;&gt;}]),
     1..|      ?assertError(_, recv(Pid, 10)).
        |  
        |  success_test() -&gt;
     1..|      Pid = create([{recv, &lt;&lt;"foobar"&gt;&gt;}, {send, &lt;&lt;"baz"&gt;&gt;}]),
        |      %?assertError({unexpected_close, _}, close(Pid)),
     1..|      ?assertEqual({ok, &lt;&lt;"foo"&gt;&gt;}, recv(Pid, 3)),
     1..|      ?assertEqual({ok, &lt;&lt;"bar"&gt;&gt;}, recv(Pid, 3)),
     1..|      ?assertEqual(ok, send(Pid, &lt;&lt;"baz"&gt;&gt;)),
     1..|      ?assertEqual(ok, close(Pid)),
        |      %% The process will exit after close. Another recv will raise noreply.
     1..|      ?assertError(noreply, recv(Pid, 3)).
        |  -endif.
</pre>
</body>
</html>
